<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Tableturf Competetive Queue</title>
    <style>
            header {
                text-align: center;
                padding: 20px 0px -5px 0px;
            }
            body {
                font-family:Arial, Helvetica, sans-serif;
                text-align: center;
            }
            .selected {
              border: 3px solid red;
            }

            .playable-selected {
              border: 3px solid green;
            }
        </style>
  </head>
  <body>
    <p id="loading-message">Loading...</p>
    <p id="players-list" style="display: none;">Player 1 vs Player 2</p>
    <p id="current-striker" style="display: none;"></p>
    <div id="player1-info" style="display: none;">
      <p id="player1-name">Player Name</p>
      <p id="player1-score">0</p>
      <button id="player1-victory-button" class="player-victory-button" value="player1" style="display: none;">Mark as winner</button>
    </div>
    <div id="player2-info">
      <p id="player2-name">Player Name</p>
      <p id="player2-score">0</p>
      <button id="player2-victory-button" class="player-victory-button" value="player2" style="display: none;">Mark as winner</button>
    </div>
    <div id="stage-selection" class="stage-selection" style="display: none;">
      <div class="stage-row">
        <div id="stage-main-street" class="stage-section starter-stage" style="display: none">
          <h3>Main Street</h3>
          <img  src="/images/Main-Street-Icon.png" />
        </div>
        <div id="stage-thunder-point" class="stage-section starter-stage" style="display: none">
          <h3>Thunder Point</h3>
          <img  src="/images/Thunder-Point-Icon.png" />
        </div>
        <div id="stage-x-marks" class="stage-section" style="display: none">
          <h3>X Marks The Garden</h3>
          <img src="/images/X-Marks-Icon.png" />
        </div>
        <div id="stage-square-squared" class="stage-section starter-stage" style="display: none">
          <h3>Square Squared</h3>
          <img  src="/images/Square-Squared-Icon.png" />
        </div>
        <div id="stage-lakefront" class="stage-section starter-stage" style="display: none">
            <h3>Lakefront Property</h3>
            <img  src="/images/Lakefront-Icon.png" />
        </div>
      </div>
      <div class="stage-row">
         <div id="stage-gemini" class="stage-section" style="display: none">
          <h3>Double Gemini</h3>
          <img  src="/images/Gemini-Icon.png" />
        </div>
         <div id="stage-river-drift" class="stage-section starter-stage" style="display: none">
          <h3>River Drift</h3>
          <img src="/images/River-Drift-Icon.png" />
        </div>
         <div id="stage-box-seats" class="stage-section" style="display: none">
          <h3>Box Seats</h3>
          <img src="/images/Box-Seats-Icon.png" />
        </div>
        <div id="stage-girder" class="stage-section" style="display: none">
            <h3>Girder For Battle</h3>
            <img  src="/images/Girder-Icon.png" />
        </div>
        <div id="stage-cracker-snap" class="stage-section" style="display: none">
            <h3>Cracker Snap</h3>
            <img  src="/images/Cracker-Snap-Icon.png" />
        </div>
      </div>
      <div class="stage-row">
        <div id="stage-mansion" class="stage-section" style="display: none">
            <h3>Mask Mansion</h3>
            <img  src="/images/Mask-Mansion-Icon.png" />
        </div>
        <div id="stage-thicket" class="stage-section" style="display: none">
            <h3>Sticky Thicket</h3>
            <img  src="/images/Sticky-Thicket-Icon.png" />
        </div>
        <div id="stage-pedal" class="stage-section" style="display: none">
            <h3>Pedal to the Metal</h3>
            <img  src="/images/Pedal-Icon.png" />
        </div>
        <div id="stage-two-lane" class="stage-section" style="display: none">
            <h3>Two-Lane Splattop</h3>
            <img  src="/images/Two-Lane-Icon.png" />
        </div>
        <div id="stage-over-the-line" class="stage-section" style="display: none">
            <h3>Over the Line</h3>
            <img  src="/images/Over-the-Line-Icon.png" />
        </div>
      </div>
      <div id="strike-wait" style="display: none;">
        <p>Please wait for your opponent.</p>
      </div>
      <div id="strike-content" style="display: none;">
        <div id="strike-info"><span id="strike-amount">1</span> stage strike remaining.</div>
        <button id="confirm-strikes">Confirm Strikes</button>
      </div>
      <div id="map-select" style="display: none;">
        <div id="strike-info">Select one of the remaining maps to play on.</div>
        <button id="confirm-map">Play Map</button>
      </div>
    </div>
    <div id="play-game" style="display: none;">
      <p id="game-info"></p>
      <p></p>
    </div>
    <p id="game-messages"></p>
    <a id="requeue-button" style="display: none;" href="/queue"><button>Queue Again</button></a>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var userData = {};
      getPlayerData();

      var strikes = [];

      const socket = io();
      var url = window.location.href;

      // General elements
      const loading = document.getElementById('loading-message');
      const players = document.getElementById('players-list');
      const stageContent = document.getElementById('stage-selection');
      const stages = document.getElementsByClassName('stage-section');
      const currentStriker = document.getElementById('current-striker');
      const strikeContent = document.getElementById('strike-content');
      const strikeButton = document.getElementById('confirm-strikes');
      const strikeInfo = document.getElementById('strike-info');
      const strikeAmount = document.getElementById('strike-amount');
      const strikeWait = document.getElementById('strike-wait');
      const mapSelect = document.getElementById('map-select');
      const playButton = document.getElementById('confirm-map');
      const playGame = document.getElementById('play-game');
      const gameInfo = document.getElementById('game-info');
      const gameMessages = document.getElementById('game-messages');
      const requeueButton = document.getElementById('requeue-button');

      // Player elements
      const player1Info = document.getElementById('player1-info');
      const player2Info = document.getElementById('player2-info');
      const player1Name = document.getElementById('player1-name');
      const player2Name = document.getElementById('player2-name');
      const player1Score = document.getElementById('player1-score');
      const player2Score = document.getElementById('player2-score');
      const player1VictoryButton = document.getElementById('player1-victory-button');
      const player2VictoryButton = document.getElementById('player2-victory-button');
      const playerVictoryButtons = document.getElementsByClassName('player-victory-button');

      var strikes = [];
      // Initial value
      var strikeCount = 1;
      // The total number of allowed strikes to validate against
      var strikeNumber = 1;
      var mapSelection = false;

      // Get the gameid from the url
      gameid = url.split('/').slice(4);
      console.log('Game id is: ' + gameid);

      //stages.forEach(function(stage) {
      for (let stage of stages ) {
        stage.addEventListener('click', function(e) {
          console.log('Classes: ' + stage.classList);
          if ( stage.classList.contains('strikeable') ) {
            stage.classList.toggle('selected');
            // If a strike is made with zero or fewer strikes remaining, don't act on it and immediately reverse the toggle
            if ( stage.classList.contains('selected') ) {
              if ( strikeCount > 0 ) {
                strikeCount--;
                strikes.push(stage.id);
              } else {
                stage.classList.toggle('selected');
              }
            } else {
              index = strikes.indexOf(stage.id);
              if (index > -1) { // only splice array when item is found
                strikes.splice(index, 1); // 2nd parameter means remove one item only
                strikeCount++;
              }
            }
            if ( strikeCount == 1 ) {
              strikeInfo.innerHTML = '<span id="strike-amount">1<span> stage strike remaining';
            } else {
              strikeInfo.innerHTML = '<span id="strike-amount">' + strikeCount + '<span> stage strikes remaining';
            }
            console.log('Strike list: ' + strikes);
          }

          if ( stage.classList.contains('playable') ) {
            for (let i = 0; i < stages.length; i++) {
              stages.item(i).classList.remove('playable-selected');
            }
            stage.classList.add('playable-selected');
          }
        });
      }
      //});

      strikeButton.addEventListener('click', (e) => {
        console.log('Sending strike data to the server ' + strikes);
        if ( validateStrikes(strikes, strikeNumber) ) {
          // send off the strike event
          socket.emit('strike', { gameid: gameid, strikes: strikes } );
        } else {
          alert('Please select ' + strikeNumber + ' maps to strike.');
        }
      });

      playButton.addEventListener('click', (e) => {
        selected = document.getElementsByClassName('playable-selected')[0].id;
        console.log('Selecting ' + selected);
        // send off the strike event
        socket.emit('play map', { gameid: gameid, selected: selected } );
      });

      for (let playerVictoryButton of playerVictoryButtons ) {
        playerVictoryButton.addEventListener('click', function(e) {
          console.log(playerVictoryButton.value + ' is the winner!');
          gameWinner = playerVictoryButton.value;
          socket.emit('player victory', { gameid: gameid, gameWinner: gameWinner });
        });
      }

      // Fire the ready event and once both players are ready the server will emit the event to begin striking
      socket.emit('game ready', gameid);

      socket.on('begin game', (gameData) => {
        // Be sure to reset the strikes every time
        strikes = [];

        console.log('Game Data: ' + JSON.stringify(gameData) );
        loading.style.display = 'none';
        player1Name.innerHTML = gameData.player1.name;
        player2Name.innerHTML = gameData.player2.name;
        player1Score.innerHTML = gameData.player1score;
        player2Score.innerHTML = gameData.player2score;

        playGame.removeChild(playGame.lastChild);
        playGame.style.display = 'none';

        player1Info.style.display = 'inline-block';
        player2Info.style.display = 'inline-block';

        strikeCount = gameData.strikeNumber;
        strikeNumber = strikeCount;
        strikeInfo.innerHTML = '<span id="strike-amount">' + strikeCount + '<span> stage strikes remaining';

        for (let playerVictoryButton of playerVictoryButtons ) {
          playerVictoryButton.style.display = 'none';
        }

        players.style.display = 'block';
        stageContent.style.display = 'block';
        if ( gameData.gameNumber == 1 ) {
          currentStriker.innerHTML = gameData.currentStriker.name + ' has won the coin toss and may strike one stage.';
        } else {
          currentStriker.innerHTML = gameData.currentStriker.name + ' may strike three stages.';
        }
        currentStriker.style.display = 'block';


        if ( gameData.currentStriker.id == userData.user.id ) {
          strikingPlayer = true;
        } else {
          strikingPlayer = false;
        }

        // If user is the current striker, make starting maps selectable and unhide the confirm selection button
        if ( strikingPlayer ) {
          strikeContent.style.display = 'block';
        } else {
          strikeWait.style.display = 'block';
        }

        if ( gameData.gameNumber == 1 ) {
          strikeableStages = document.getElementsByClassName('starter-stage');
          for (let i = 0; i < strikeableStages.length; i++) {
            if ( strikingPlayer ) {
              strikeableStages.item(i).classList.add('strikeable');
            }
            strikeableStages.item(i).style.display = 'inline-block';
          }
        } else {
          // Make all stages strikeable after game 1
          strikeableStages = document.getElementsByClassName('stage-section');
          for (let i = 0; i < strikeableStages.length; i++) {
            if ( strikingPlayer ) {
              strikeableStages.item(i).classList.add('strikeable');
            }
            strikeableStages.item(i).style.display = 'inline-block';
          }
        }
      });

      socket.on('invalid game', (destination) => {
        console.log('Redirection event, going to ' + destination);
        window.location.href = destination;
      });

      socket.on('invalid strikes', () => {
        // Temporary, there will be a notification/message div on the final page
        alert('You have made a mistake in striking. Please correct the error and try again.');
      });

      socket.on('apply strikes', (strikes, gameData) => {
        console.log('received strikes!');
        console.log(strikes);
        console.log('New striker is: ' + gameData.currentStriker.id + ' and gets ' + gameData.strikeNumber + 'strikes!');

        strikeCount = gameData.strikeNumber;
        strikeNumber = strikeCount;
        if ( strikeCount == -10 ) {
          mapSelection = true;
        }

        if ( gameData.gameNumber == 1 ) {
          strikeableStages = document.getElementsByClassName('starter-stage');
        } else {
          strikeableStages = document.getElementsByClassName('stage-section');
        }

        if ( gameData.currentStriker.id == userData.user.id ) {
          if ( mapSelection ) {
            mapSelect.style.display = 'block';
            strikeContent.style.display = 'none';
            strikeWait.style.display = 'none';
          } else {
            strikeContent.style.display = 'block';
            strikeWait.style.display = 'none';
            strikeInfo.innerHTML = '<span id="strike-amount">' + strikeCount + '<span> stage strikes remaining';
          }
          
          // Either add the strikeable class or if this is the final selection, add the playable class
          for (let i = 0; i < strikeableStages.length; i++) {
            if ( mapSelection ) {
              strikeableStages.item(i).classList.add('playable');
            } else {
              strikeableStages.item(i).classList.add('strikeable');
            }
          }
        } else {
          for (let i = 0; i < strikeableStages.length; i++) {
            strikeableStages.item(i).classList.remove('strikeable');
          }
          strikeContent.style.display = 'none';
          strikeWait.style.display = 'block';
        }

        for( var i = 0; i < strikes.length; i++ ) {
          stage = document.getElementById(strikes[i]);
          if ( !stage.classList.contains('selected') ) {
            stage.classList.toggle('selected');
            // Remove the strikeable and playable classes since this stage is already stricken
            stage.classList.remove('strikeable');
            stage.classList.remove('playable');
          }
        }
      });

      socket.on('start game', (gameData, selected) => {
        console.log('The selected stage is: ' + selected);
        stageContent.style.display = 'none';
        selectedStage = document.getElementById(selected);
        selectedStage.classList.remove('playable-selected');

        gameInfo.innerHTML = 'Game ' + gameData.gameNumber + ' will be played on';
        playGame.append( selectedStage.cloneNode(true) );
        playGame.style.display = 'block';

        player1VictoryButton.value = gameData.player1.id;
        player2VictoryButton.value = gameData.player2.id;

        for ( let playerVictoryButton of playerVictoryButtons ) {
          playerVictoryButton.style.display = 'block';
        }

        for ( let stage of stages ) {
          stage.classList.remove('selected');
          stage.classList.remove('playable');
        }

        mapSelect.style.display = 'none';

      });

      socket.on('game finished', (gameData) => {
        // Update the score a final time
        player1Score.innerHTML = gameData.player1score;
        player2Score.innerHTML = gameData.player2score;

        // Hide buttons a final time
        for (let playerVictoryButton of playerVictoryButtons ) {
          playerVictoryButton.style.display = 'none';
        }

        console.log('The game is over');
        stageContent.style.display = 'none';
        playGame.style.display = 'none';
        gameMessages.innerHTML = gameData.matchWinner.name + ' has won the set.';
        requeueButton.style.display = 'block';        
      });

      async function getPlayerData() {
        const response = await fetch('/player');
        userData = await response.json();
        console.log(userData);
      }

      function validateStrikes(strikes, strikeCount) {
        if ( strikes.length != strikeCount ) 
          return false;
        else
          return true;
      }
    </script>

  </body>
</html>